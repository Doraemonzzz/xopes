# Lightning Attention with Scalar Decay

## Notation

- lacd_r: Triton recurrence
- lacd_p: Lightning attention with constant decay
- land_p: Lightning attention with no decay
- lacd_pl: Lightning attention with learnable constant decay
- lasd_p: Lightning attention with scalar decay
- lasr_r: Lightning attention with scalar decay recurrence
- lavd_k_p: Lightning attention with key vector decay
- lavd_kv_p: Lightning attention with key-value vector decay
- flash: Flash attention
- lightning_p: Origin lightning attention parallel version
- lightning_c: Origin lightning attention chunk loop version
- gla_k: GLA with key decay
- gla_s_k: GLA with scalar decay

## A100

### LAER
```
la-speed-fwd-batch4-head32-dim128-bf16:
         n     LAER_R    LAER_P   FLA_LAER
0    256.0   0.179150  0.121792   0.161870
1    512.0   0.343455  0.148611   0.266417
2   1024.0   0.671317  0.275527   0.458557
3   2048.0   1.331485  0.529932   0.886144
4   4096.0   2.656552  1.035586   1.741473
5   8192.0   5.316374  2.047637   3.433284
6  16384.0  10.529084  4.078549   6.825684
7  32768.0  21.357952  8.137453  13.676878

la-speed-bwd-batch4-head32-dim128-bf16:
         n     LAER_R     LAER_P   FLA_LAER
0    256.0   0.668675   0.258115   0.319794
1    512.0   1.341009   0.352980   0.565582
2   1024.0   2.663600   0.658547   1.072992
3   2048.0   5.293043   1.270049   1.993207
4   4096.0  10.651805   2.496609   3.860527
5   8192.0  21.629713   4.934949   7.639254
6  16384.0  43.558945   9.870859  15.237535
7  32768.0  88.238304  19.698689  30.423637
```

### Large Batch * Number of Heads

#### Speed

```
la-speed-fwd-batch4-head32-dim128-bf16:
         n     LACD_R    LACD_P    LAND_P   LACD_PL    LASD_P   LAVD_K_P  LAVD_KV_P     LASR_R       Flash         LP         LC      GLA_K   GLA_S_K
0    256.0   0.652598  0.130889  0.135166  0.138015  0.210610   0.330922   0.491636   0.176898    0.053667   0.240018   0.207011   0.328834  0.205450
1    512.0   1.269114  0.152028  0.140460  0.152093  0.235318   0.496905   0.924824   0.337565    0.107117   0.439877   0.375587   0.508984  0.199883
2   1024.0   2.499939  0.276337  0.245920  0.276192  0.255473   0.947353   1.786060   0.654730    0.256391   0.863123   0.714587   0.959788  0.271861
3   2048.0   4.949769  0.507340  0.451575  0.507583  0.468877   1.851878   3.535192   1.293852    0.799278   1.673230   1.388267   1.876553  0.509009
4   4096.0   9.742852  0.967905  0.862262  0.968603  0.894832   3.684103   7.002536   2.564764    2.824819   3.259303   2.748047   3.719603  0.976700
5   8192.0  19.716570  1.895362  1.677649  1.895616  1.762733   7.277847  14.864507   5.162487   10.727610   6.434144   5.449807   7.492152  1.924348
6  16384.0  39.276787  3.764310  3.327860  3.769155  3.537891  14.538208  27.842667  10.342720   41.703167  12.784063  10.891139  15.157756  3.876681
7  32768.0  78.788483  7.482481  6.585248  7.484857  7.200048  29.039062  55.617889  20.767073  165.819138  25.506134  21.742970  30.887733  7.960880

la-speed-bwd-batch4-head32-dim128-bf16:
         n      LACD_R     LACD_P     LAND_P    LACD_PL     LASD_P   LAVD_K_P   LAVD_KV_P     LASR_R       Flash         LP          LC       GLA_K    GLA_S_K
0    256.0    3.057794   0.450973   0.453306   0.666072   0.754895   1.093595    1.984203   0.669865    0.188124   0.638220    5.962618    0.900612   0.657125
1    512.0    6.093389   0.516676   0.508241   0.720287   0.776197   1.860895    3.498240   1.341804    0.385978   1.188163   12.471520    1.705471   0.631012
2   1024.0   12.163743   0.771498   0.729288   0.888928   0.882430   3.433316    7.089076   2.654108    0.936025   2.268123   25.208235    3.299474   1.081707
3   2048.0   24.300600   1.425927   1.353799   1.618610   1.607084   6.544034   14.137328   5.331770    2.675452   4.372825   50.888191    6.492832   2.098145
4   4096.0   48.688866   2.734320   2.599301   3.067722   3.061687  12.880562   27.758795  10.622116    8.626735   8.665167  102.149406   12.897513   4.197867
5   8192.0   96.999550   5.283563   5.068948   5.941888   6.012902  22.588608   47.120544  21.602896   30.809738  17.615423  204.841980   25.774836   8.646801
6  16384.0  194.189468  10.498177  10.043834  11.785418  12.079256  45.020226   94.062622  43.676064  116.588478  35.064034  409.616119   51.636894  17.887060
7  32768.0  388.093262  20.701385  19.908312  23.348879  23.784008  89.899231  187.883270  88.001152  453.673065  70.100319  819.717529  103.829636  36.737228
```

#### Memory
```
la-memory-fwd-batch4-head32-dim128-bf16:
         n       LACD_R       LACD_P       LAND_P      LACD_PL       LASD_P     LAVD_K_P     LAVD_KV_P       LASR_R        Flash            LP           LC         GLA_K      GLA_S_K
0    256.0    56.062988    60.062988    60.062988    60.062988    60.187988    77.062988     93.062988    48.094238    48.188477     80.063477    72.063477     96.062988    72.187988
1    512.0   104.125488   116.125488   116.125488   116.125488   116.375488   150.125488    182.125488    96.156738    96.375977    160.125977   144.125977    184.125488   136.375488
2   1024.0   200.250488   228.250488   228.250488   228.250488   228.750488   296.250488    360.250488   192.281738   192.750977    320.250977   288.250977    360.250488   264.750488
3   2048.0   392.500488   452.500488   452.500488   452.500488   453.500488   588.500488    716.500488   384.531738   385.500977    640.500977   576.500977    712.500488   521.500488
4   4096.0   777.000488   901.000488   901.000488   901.000488   903.000488  1173.000488   1429.000488   769.031738   771.000977   1281.000977  1153.000977   1417.000488  1035.000488
5   8192.0  1546.000488  1798.000488  1798.000488  1798.000488  1802.000488  2342.000488   2854.000488  1538.031738  1542.000977   2562.000977  2306.000977   2826.000488  2062.000488
6  16384.0  3084.000488  3592.000488  3592.000488  3592.000488  3600.000488  4680.000488   5704.000488  3076.031738  3084.000977   5124.000977  4612.000977   5644.000488  4116.000488
7  32768.0  6160.000488  7180.000488  7180.000488  7180.000488  7196.000488  9356.000488  11404.000488  6152.031738  6168.000977  10248.000977  9224.000977  11280.000488  8224.000488

la-memory-bwd-batch4-head32-dim128-bf16:
         n        LACD_R        LACD_P        LAND_P       LACD_PL        LASD_P      LAVD_K_P     LAVD_KV_P        LASR_R         Flash            LP            LC         GLA_K       GLA_S_K
0    256.0    115.262988    127.262988    127.262988    131.451367    131.750977    211.694238    290.094238    129.787988    115.513477    139.263477    124.863477    273.662988    171.562988
1    512.0    214.525488    242.525488    242.525488    246.901367    247.500977    407.356738    564.156738    259.450488    231.025977    278.525977    249.725977    539.325488    335.125488
2   1024.0    413.050488    473.050488    473.050488    477.801367    479.000977    798.681738   1112.281738    518.775488    462.050977    557.050977    499.450977   1070.650488    662.250488
3   2048.0    810.100488    934.100488    934.100488    939.601367    942.000977   1581.331738   2208.531738   1037.425488    924.100977   1114.100977    998.900977   2133.300488   1316.500488
4   4096.0   1604.200488   1856.200488   1856.200488   1863.201367   1868.000977   3146.631738   4401.031738   2074.725488   1848.200977   2228.200977   1997.800977   4258.600488   2625.000488
5   8192.0   3192.400488   3700.400488   3700.400488   3710.401367   3720.000977   6277.231738   8786.031738   4149.325488   3696.400977   4456.400977   3995.600977   8509.200488   5242.000488
6  16384.0   6368.800488   7388.800488   7388.800488   7404.801367   7424.000977  12538.431738  17556.031738   8298.525488   7392.800977   8912.800977   7991.200977  17010.400488  10476.000488
7  32768.0  12721.600488  14765.600488  14765.600488  14793.601367  14832.000977  25060.831738  35096.031738  16596.925488  14785.600977  17825.600977  15982.400977  34012.800488  20944.000488
```

### Small Batch * Number of Heads

#### Speed
```
la-speed-fwd-batch1-head16-dim128-bf16:
         n     LACD_R    LACD_P    LAND_P   LACD_PL    LASD_P  LAVD_K_P  LAVD_KV_P     LASR_R      Flash        LP        LC     GLA_K   GLA_S_K
0    256.0   0.527193  0.233075  0.208391  0.211615  0.293226  0.426574   0.501104   0.152296   0.034272  0.235315  0.146698  0.374866  0.234599
1    512.0   1.042136  0.213882  0.206954  0.225404  0.324612  0.426167   0.508682   0.294949   0.045254  0.241644  0.130140  0.335468  0.212212
2   1024.0   2.091674  0.207035  0.222346  0.216702  0.350693  0.425794   0.526631   0.591194   0.071540  0.244571  0.133697  0.331128  0.213340
3   2048.0   4.222878  0.220219  0.209568  0.223613  0.296072  0.436858   0.507599   1.180574   0.161713  0.254550  0.246344  0.337616  0.246204
4   4096.0   8.389154  0.262086  0.218017  0.225357  0.310244  0.528679   0.965255   2.312238   0.464565  0.472194  0.468979  0.574918  0.222680
5   8192.0  16.743015  0.364561  0.321389  0.364426  0.372763  1.040695   1.898933   4.627904   1.528152  0.962265  0.908440  1.100804  0.386227
6  16384.0  33.391167  0.664666  0.586622  0.663521  0.641208  2.054555   3.757513   9.180905   5.457597  1.859973  1.795907  2.175878  0.747503
7  32768.0  66.866463  1.277018  1.131106  1.275180  1.222017  4.084047   7.482308  18.382547  21.230433  3.660052  3.570090  4.351929  1.482417

la-speed-bwd-batch1-head16-dim128-bf16:
         n      LACD_R    LACD_P    LAND_P   LACD_PL    LASD_P   LAVD_K_P  LAVD_KV_P     LASR_R      Flash        LP          LC      GLA_K   GLA_S_K
0    256.0    1.955099  0.607522  0.528209  0.775732  0.968352   1.111545   1.569281   0.481787   0.135022  0.239032    2.131120   0.732915  0.770614
1    512.0    4.408568  0.519716  0.561987  0.784328  0.887238   1.120196   1.549096   0.742598   0.179804  0.279846    4.346137   0.765017  0.629301
2   1024.0    7.841156  0.531315  0.571937  0.833903  0.866473   1.175452   1.527994   1.581932   0.175663  0.365971    8.705256   0.720017  0.603262
3   2048.0   16.049156  0.534427  0.586873  0.891382  0.854735   1.186953   2.788313   3.261328   0.451130  0.623948   17.801447   0.972537  0.699065
4   4096.0   32.546307  0.630072  0.560954  0.789386  0.914611   2.265485   4.968230   6.888605   1.271576  1.163030   35.632992   1.857019  0.689522
5   8192.0   65.388451  1.174439  1.039980  1.176925  1.200278   4.486904   9.111036  13.366597   4.128099  2.287377   71.287811   3.613893  1.313596
6  16384.0  131.668121  2.173007  1.953203  2.181113  2.165070   9.098483  19.489777  27.081282  14.693135  4.508713  142.727097   7.115446  2.554074
7  32768.0  262.792206  4.183788  3.730476  4.186276  4.173561  17.579967  34.723583  53.144512  56.287006  8.889632  284.873871  14.180528  5.068643
```

#### Memory
```
la-memory-fwd-batch1-head16-dim128-bf16:
         n      LACD_R      LACD_P      LAND_P     LACD_PL      LASD_P     LAVD_K_P    LAVD_KV_P      LASR_R       Flash           LP           LC        GLA_K      GLA_S_K
0    256.0    7.008301    7.508301    7.508301    7.508301    7.523926     9.633301    11.633301    6.012207   10.055664    10.008789     9.008789    12.008301     9.023926
1    512.0   13.016113   14.516113   14.516113   14.516113   14.547363    18.766113    22.766113   12.020020   28.172852    20.016602    18.016602    23.016113    17.047363
2   1024.0   25.031738   26.531738   26.531738   26.531738   26.594238    37.031738    45.031738   24.035645   24.094727    40.032227    36.032227    45.031738    33.094238
3   2048.0   49.062988   52.562988   52.562988   52.562988   52.687988    73.562988    89.562988   48.066895   48.188477    80.063477    72.063477    89.062988    65.187988
4   4096.0   97.125488  104.625488  104.625488  104.625488  104.875488   146.625488   178.625488   96.129395   96.375977   160.125977   144.125977   177.125488   129.375488
5   8192.0  193.250488  208.750488  208.750488  208.750488  209.250488   292.750488   356.750488  192.254395  192.750977   320.250977   288.250977   353.250488   257.750488
6  16384.0  385.500488  417.000488  417.000488  417.000488  418.000488   585.000488   713.000488  384.504395  385.500977   640.500977   576.500977   705.500488   514.500488
7  32768.0  770.000488  833.500488  833.500488  833.500488  835.500488  1169.500488  1425.500488  769.004395  771.000977  1281.000977  1153.000977  1410.000488  1028.000488

la-memory-bwd-batch1-head16-dim128-bf16:
         n       LACD_R       LACD_P       LAND_P      LACD_PL       LASD_P     LAVD_K_P    LAVD_KV_P       LASR_R        Flash           LP           LC        GLA_K      GLA_S_K
0    256.0    14.408301    15.908301    15.908301    16.432617    16.469727    26.462207    36.262207    16.223926    14.440039    17.408789    15.608789    34.208301    21.445801
1    512.0    26.816113    30.716113    30.716113    31.263867    31.338477    50.920020    70.520020    32.431738    28.879102    34.816602    31.216602    67.416113    41.891113
2   1024.0    51.631738    55.131738    55.131738    55.726367    55.875977    99.835645   139.035645    64.847363    57.757227    69.632227    62.432227   133.831738    82.781738
3   2048.0   101.262988   108.762988   108.762988   109.451367   109.750977   197.666895   276.066895   129.678613   115.513477   139.263477   124.863477   266.662988   164.562988
4   4096.0   200.525488   216.025488   216.025488   216.901367   217.500977   393.329395   550.529395   259.341113   231.025977   278.525977   249.725977   532.325488   328.125488
5   8192.0   399.050488   430.550488   430.550488   431.801367   433.000977   784.654395  1098.654395   518.666113   462.050977   557.050977   499.450977  1063.650488   655.250488
6  16384.0   796.100488   859.600488   859.600488   861.633105   864.000977  1567.304395  2194.904395  1037.316113   924.100977  1114.100977   998.900977  2126.300488  1309.500488
7  32768.0  1590.200488  1717.700488  1717.700488  1721.764355  1726.000977  3132.604395  4387.004395  2074.616113  1848.200977  2228.200977  1997.800977  4251.600488  2618.000488
```
