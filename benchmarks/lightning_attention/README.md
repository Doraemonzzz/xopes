# Lightning Attention with Scalar Decay

## Notation

- lasd_r: Triton recurrence
- lasd_p: Lightning attention with scalar decay
- land_p: Lightning attention with no decay
- lasd_pl: Lightning attention with learnable scalar decay
- flash: Flash attention
- lightning_p: Origin lightning attention parallel version
- lightning_c: Origin lightning attention chunk loop version

## A100

### Large Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch4-head32-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL    LASD3_P       Flash         LP         LC      GLA_K   GLA_S_K
0    256.0   0.654193  0.134419  0.115405  0.117149   0.328706    0.053660   0.263937   0.206468   0.401679  0.202519
1    512.0   1.269749  0.151838  0.153183  0.164807   0.391592    0.106682   0.440645   0.374645   0.510627  0.223473
2   1024.0   2.512462  0.275149  0.236390  0.275726   0.414684    0.256349   0.863965   0.713574   0.963812  0.272153
3   2048.0   4.972871  0.504537  0.435221  0.504503   0.776564    0.798896   1.670817   1.385297   1.884043  0.506327
4   4096.0   9.945287  0.968480  0.833967  0.961484   1.489485    2.879688   3.269797   2.734866   3.745527  0.975027
5   8192.0  19.787289  1.893483  1.628906  1.890837   2.919869   10.866869   6.451684   5.428779   7.526730  1.920681
6  16384.0  39.621986  3.755999  3.222601  3.756915   5.816726   42.272495  12.794501  10.830364  15.216347  3.883314
7  32768.0  78.899300  7.471749  6.412169  7.464744  11.788404  167.834625  25.573313  21.660271  30.994551  8.008973


lasd-speed-bwd-batch4-head32-dim128-bf16:
         n      LASD_R     LASD_P     LAND_P    LASD_PL    LASD3_P       Flash         LP          LC       GLA_K    GLA_S_K
0    256.0    3.070791   0.476827   0.459765   1.140183   1.181632    0.188058   0.639644    5.995980    0.926647   0.650101
1    512.0    6.124137   0.460323   0.467098   1.137625   1.172461    0.385401   1.191536   12.539355    1.707379   0.618690
2   1024.0   12.221540   0.764867   0.699031   1.035535   1.459502    0.936586   2.275914   25.387701    3.300846   1.083748
3   2048.0   24.397449   1.423814   1.299476   1.639142   2.684925    2.674651   4.386336   51.231647    6.516396   2.095081
4   4096.0   48.588928   2.719774   2.497730   3.083892   5.148256    8.713673   8.678386  102.802109   12.926474   4.186003
5   8192.0   97.538429   5.297657   4.882771   5.954522  10.110752   31.451500  17.606976  205.494370   25.876640   8.593632
6  16384.0  195.392059  10.511566   9.679664  11.786417  20.028591  118.465218  35.182510  412.692566   51.731392  17.714388
7  32768.0  390.116425  20.704662  20.925415  23.408144  40.552879  458.347473  70.393791  824.577454  103.714432  36.342224
```

#### Memory
```
lasd-memory-fwd-batch4-head32-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC         GLA_K      GLA_S_K
0    256.0    48.062988    52.062988    52.062988    52.062988    64.125488    40.188477    72.063477    64.063477     88.062988    64.187988
1    512.0    88.125488   100.125488   100.125488   100.125488   120.250488    80.375977   144.125977   128.125977    168.125488   120.375488
2   1024.0   168.250488   196.250488   196.250488   196.250488   200.500488   160.750977   288.250977   256.250977    328.250488   232.750488
3   2048.0   328.500488   388.500488   388.500488   388.500488   393.000488   321.500977   576.500977   512.500977    648.500488   457.500488
4   4096.0   649.000488   773.000488   773.000488   773.000488   778.000488   643.000977  1153.000977  1025.000977   1289.000488   907.000488
5   8192.0  1290.000488  1542.000488  1542.000488  1542.000488  1548.000488  1286.000977  2306.000977  2050.000977   2570.000488  1806.000488
6  16384.0  2572.000488  3080.000488  3080.000488  3080.000488  3088.000488  2572.000977  4612.000977  4100.000977   5132.000488  3604.000488
7  32768.0  5136.000488  6156.000488  6156.000488  6156.000488  6168.000488  5144.000977  9224.000977  8200.000977  10256.000488  7200.000488

lasd-memory-bwd-batch4-head32-dim128-bf16:
         n        LASD_R        LASD_P        LAND_P       LASD_PL       LASD3_P         Flash            LP            LC         GLA_K       GLA_S_K
0    256.0    107.262988    119.262988    119.262988    123.576367    171.625977    107.513477    131.263477    116.863477    265.662988    163.562988
1    512.0    198.525488    226.525488    226.525488    231.151367    319.250977    215.025977    262.525977    233.725977    523.325488    319.125488
2   1024.0    381.050488    441.050488    441.050488    446.301367    550.500977    430.050977    525.050977    467.450977   1038.650488    630.250488
3   2048.0    746.100488    870.100488    870.100488    876.601367   1077.000977    860.100977   1050.100977    934.900977   2069.300488   1252.500488
4   4096.0   1476.200488   1728.200488   1728.200488   1737.201367   2130.000977   1720.200977   2100.200977   1869.800977   4130.600488   2497.000488
5   8192.0   2936.400488   3444.400488   3444.400488   3458.401367   4236.000977   3440.400977   4200.400977   3739.600977   8253.200488   4986.000488
6  16384.0   5856.800488   6876.800488   6876.800488   6900.801367   8448.000977   6880.800977   8400.800977   7479.200977  16498.400488   9964.000488
7  32768.0  11697.600488  13741.600488  13741.600488  13785.601367  16872.000977  13761.600977  16801.600977  14958.400977  32988.800488  19920.000488
```

### Small Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch1-head16-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP        LC     GLA_K   GLA_S_K
0    256.0   0.529204  0.185659  0.179235  0.208015  0.353364   0.027784  0.240692  0.115497  0.347409  0.235911
1    512.0   1.047968  0.188740  0.185055  0.217495  0.350787   0.045247  0.294609  0.121151  0.368981  0.257062
2   1024.0   2.103771  0.210293  0.303911  0.276050  0.380936   0.071591  0.240090  0.133760  0.361914  0.199491
3   2048.0   4.242272  0.203285  0.192979  0.201667  0.354098   0.161931  0.278039  0.246495  0.340223  0.278293
4   4096.0   8.444678  0.201442  0.184056  0.227532  0.361081   0.466145  0.475555  0.470738  0.573004  0.266605
5   8192.0  16.830631  0.361970  0.320908  0.362084  0.429265   1.531596  0.970546  0.909624  1.104923  0.387630
6  16384.0  33.602829  0.660469  0.586424  0.661271  0.813514   5.624042  1.860419  1.787253  2.176623  0.750859
7  32768.0  67.126465  1.272816  1.129001  1.273885  1.590781  21.579929  3.658860  3.537979  4.357739  1.478395

lasd-speed-bwd-batch1-head16-dim128-bf16:
         n      LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP          LC      GLA_K   GLA_S_K
0    256.0    1.968393  0.604671  0.496243  1.053034  1.137228   0.133662  0.260892    2.495621   0.724429  0.604701
1    512.0    4.744251  0.565940  0.518656  1.162408  1.128376   0.150711  0.283558    5.316620   0.742411  0.602991
2   1024.0    7.884101  0.504530  0.556835  1.058658  1.167818   0.174917  0.437843   10.637372   0.762911  0.626446
3   2048.0   16.158346  0.539562  0.500449  1.081501  1.214865   0.451175  0.725892   18.362305   0.971725  0.594619
4   4096.0   32.730988  0.631781  0.564775  1.095397  1.138801   1.272451  1.348438   35.474525   1.858666  0.708017
5   8192.0   65.775871  1.171730  1.039733  1.152653  1.436818   4.137148  2.730034   70.854881   3.620327  1.262560
6  16384.0  132.103302  2.117507  1.947860  2.100775  2.696368  14.704944  5.390118  141.910080   7.129482  2.449326
7  32768.0  264.961884  4.185740  3.718101  4.035714  5.257084  56.323296  9.741020  283.582458  14.215232  4.879615
```

#### Memory
```
lasd-memory-fwd-batch1-head16-dim128-bf16:
         n      LASD_R      LASD_P      LAND_P     LASD_PL     LASD3_P       Flash           LP           LC        GLA_K     GLA_S_K
0    256.0    6.008301    6.508301    6.508301    6.508301    8.016113    9.055664     9.008789     8.008789    11.008301    8.023926
1    512.0   11.016113   12.516113   12.516113   12.516113   15.031738   26.172852    18.016602    16.016602    21.016113   15.047363
2   1024.0   21.031738   22.531738   22.531738   22.531738   25.062988   20.094727    36.032227    32.032227    41.031738   29.094238
3   2048.0   41.062988   44.562988   44.562988   44.562988   49.125488   40.188477    72.063477    64.063477    81.062988   57.187988
4   4096.0   81.125488   88.625488   88.625488   88.625488   97.250488   80.375977   144.125977   128.125977   161.125488  113.375488
5   8192.0  161.250488  176.750488  176.750488  176.750488  193.500488  160.750977   288.250977   256.250977   321.250488  225.750488
6  16384.0  321.500488  353.000488  353.000488  353.000488  386.000488  321.500977   576.500977   512.500977   641.500488  450.500488
7  32768.0  642.000488  705.500488  705.500488  705.500488  771.000488  643.000977  1153.000977  1025.000977  1282.000488  900.000488

lasd-memory-bwd-batch1-head16-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC        GLA_K      GLA_S_K
0    256.0    13.408301    14.908301    14.908301    15.448242    21.454102    13.440039    16.408789    14.608789    33.208301    20.445801
1    512.0    24.816113    28.516113    28.516113    29.095117    41.707227    26.879102    32.816602    29.216602    65.416113    39.891113
2   1024.0    47.631738    51.131738    51.131738    51.788867    68.813477    53.757227    65.632227    58.432227   129.831738    78.781738
3   2048.0    93.262988   100.762988   100.762988   101.576367   134.625977   107.513477   131.263477   116.863477   258.662988   156.562988
4   4096.0   184.525488   200.025488   200.025488   201.151367   266.250977   215.025977   262.525977   233.725977   516.325488   312.125488
5   8192.0   367.050488   398.550488   398.550488   400.301367   529.500977   430.050977   525.050977   467.450977  1031.650488   623.250488
6  16384.0   732.100488   795.600488   795.600488   798.601367  1056.000977   860.100977  1050.100977   934.900977  2062.300488  1245.500488
7  32768.0  1462.200488  1589.700488  1589.700488  1595.201367  2109.000977  1720.200977  2100.200977  1869.800977  4123.600488  2490.000488
```
