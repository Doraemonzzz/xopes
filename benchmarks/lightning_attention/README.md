# Lightning Attention with Scalar Decay

## Notation

- lasd_r: Triton recurrence
- lasd_p: Lightning attention with scalar decay
- land_p: Lightning attention with no decay
- lasd_pl: Lightning attention with learnable scalar decay
- lasd3_p: Lightning attention with data-dependent scalar decay
- flash: Flash attention
- lightning_p: Origin lightning attention parallel version
- lightning_c: Origin lightning attention chunk loop version

## A100

### Large Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch4-head32-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P       Flash         LP         LC      GLA_K   GLA_S_K
0    256.0   0.655475  0.116872  0.108777  0.112179  0.189620    0.053744   0.239595   0.206059   0.327374  0.189048
1    512.0   1.272765  0.151152  0.133496  0.153617  0.209303    0.107022   0.439699   0.376377   0.510669  0.195082
2   1024.0   2.510926  0.275598  0.236668  0.275271  0.254790    0.257352   0.862833   0.715819   0.960519  0.269465
3   2048.0   4.970295  0.506350  0.436466  0.506020  0.465846    0.809441   1.673610   1.393381   1.874986  0.498503
4   4096.0   9.927938  0.964464  0.833791  0.965722  0.887526    2.885632   3.290387   2.744945   3.735913  0.979784
5   8192.0  19.669868  1.884969  1.623172  1.885648  1.739210   10.936665   6.444158   5.449149   7.489881  2.039744
6  16384.0  39.467487  3.756338  3.225409  3.755707  3.493051   42.241409  12.827734  10.886965  15.186385  4.446343
7  32768.0  78.865501  7.467283  6.389360  7.463058  7.167580  168.343933  25.553185  21.781336  30.934900  9.701565

lasd-speed-bwd-batch4-head32-dim128-bf16:
         n      LASD_R     LASD_P     LAND_P    LASD_PL    LASD3_P       Flash         LP          LC       GLA_K    GLA_S_K
0    256.0    3.068445   0.451759   0.401922   0.947972   0.759867    0.191533   0.637450    5.999949    0.901561   0.603744
1    512.0    6.111310   0.429358   0.419973   0.987611   0.753694    0.385284   1.187611   12.532434    1.704199   0.643662
2   1024.0   12.233656   0.766972   0.700016   1.017305   0.896376    0.950504   2.264084   25.504044    3.297035   1.081328
3   2048.0   24.358343   1.422142   1.296878   1.635976   1.562316    2.675035   4.372067   51.231552    6.495844   2.098839
4   4096.0   48.804913   2.724166   2.496056   3.081721   2.992017    8.690695   8.656277  103.146851   12.914285   4.201920
5   8192.0   97.399170   5.323214   4.904049   5.982278   5.904106   31.196800  17.681057  205.659897   25.809301   8.621899
6  16384.0  194.522461  10.439133   9.671779  11.776476  11.764616  117.908386  35.132832  413.152313   51.734592  17.889688
7  32768.0  390.067566  20.604305  19.182785  23.395168  23.545734  461.492767  70.160576  825.755188  103.798462  36.594498
```

#### Memory
```
lasd-memory-fwd-batch4-head32-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC         GLA_K      GLA_S_K
0    256.0    48.062988    52.062988    52.062988    52.062988    52.125488    40.188477    72.063477    64.063477     88.062988    64.187988
1    512.0    88.125488   100.125488   100.125488   100.125488   100.250488    80.375977   144.125977   128.125977    168.125488   120.375488
2   1024.0   168.250488   196.250488   196.250488   196.250488   196.500488   160.750977   288.250977   256.250977    328.250488   232.750488
3   2048.0   328.500488   388.500488   388.500488   388.500488   389.000488   321.500977   576.500977   512.500977    648.500488   457.500488
4   4096.0   649.000488   773.000488   773.000488   773.000488   774.000488   643.000977  1153.000977  1025.000977   1289.000488   907.000488
5   8192.0  1290.000488  1542.000488  1542.000488  1542.000488  1544.000488  1286.000977  2306.000977  2050.000977   2570.000488  1806.000488
6  16384.0  2572.000488  3080.000488  3080.000488  3080.000488  3084.000488  2572.000977  4612.000977  4100.000977   5132.000488  3604.000488
7  32768.0  5136.000488  6156.000488  6156.000488  6156.000488  6164.000488  5144.000977  9224.000977  8200.000977  10256.000488  7200.000488

lasd-memory-bwd-batch4-head32-dim128-bf16:
         n        LASD_R        LASD_P        LAND_P       LASD_PL       LASD3_P         Flash            LP            LC         GLA_K       GLA_S_K
0    256.0    107.262988    119.262988    119.262988    123.576367    123.625977    107.513477    131.263477    116.863477    265.662988    163.562988
1    512.0    198.525488    226.525488    226.525488    231.151367    231.250977    215.025977    262.525977    233.725977    523.325488    319.125488
2   1024.0    381.050488    441.050488    441.050488    446.301367    446.500977    430.050977    525.050977    467.450977   1038.650488    630.250488
3   2048.0    746.100488    870.100488    870.100488    876.601367    877.000977    860.100977   1050.100977    934.900977   2069.300488   1252.500488
4   4096.0   1476.200488   1728.200488   1728.200488   1737.201367   1738.000977   1720.200977   2100.200977   1869.800977   4130.600488   2497.000488
5   8192.0   2936.400488   3444.400488   3444.400488   3458.401367   3460.000977   3440.400977   4200.400977   3739.600977   8253.200488   4986.000488
6  16384.0   5856.800488   6876.800488   6876.800488   6900.801367   6904.000977   6880.800977   8400.800977   7479.200977  16498.400488   9964.000488
7  32768.0  11697.600488  13741.600488  13741.600488  13785.601367  13792.000977  13761.600977  16801.600977  14958.400977  32988.800488  19920.000488
```

### Small Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch1-head16-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP        LC     GLA_K   GLA_S_K
0    256.0   0.527626  0.178751  0.169910  0.178969  0.261327   0.027541  0.216531  0.098789  0.362321  0.192749
1    512.0   1.048164  0.186925  0.176245  0.189078  0.263025   0.044586  0.227445  0.103869  0.315590  0.196391
2   1024.0   2.105641  0.182304  0.181671  0.191975  0.257250   0.071177  0.210683  0.133228  0.314332  0.187503
3   2048.0   4.244342  0.194179  0.184758  0.192805  0.286748   0.159586  0.250570  0.245895  0.325015  0.187759
4   4096.0   8.436166  0.200985  0.182449  0.200945  0.283639   0.461866  0.473404  0.467700  0.571349  0.195393
5   8192.0  16.853199  0.361708  0.320198  0.361738  0.365390   1.528627  0.972261  0.908956  1.103458  0.351976
6  16384.0  33.624527  0.663714  0.587166  0.662642  0.668982   5.608883  1.866336  1.797516  2.176361  0.679652
7  32768.0  67.047424  1.267679  1.123405  1.268412  1.274970  21.610680  3.699413  3.569438  4.362281  1.322791

lasd-speed-bwd-batch1-head16-dim128-bf16:
         n      LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP          LC      GLA_K   GLA_S_K
0    256.0    1.964803  0.526395  0.537161  1.070948  0.864993   0.138496  0.218946    2.123611   0.694244  0.593077
1    512.0    3.898972  0.545902  0.514289  1.096274  0.786464   0.115286  0.236423    4.319210   0.762752  0.589003
2   1024.0    7.871416  0.524634  0.470127  1.057648  0.795881   0.175112  0.366035    8.703789   0.706621  0.599138
3   2048.0   16.164347  0.484963  0.521955  1.124316  0.836656   0.451000  0.623109   17.632492   0.971017  0.595109
4   4096.0   32.704533  0.564400  0.506220  1.087109  0.836296   1.271206  1.158922   35.553551   1.859657  0.687657
5   8192.0   65.730659  1.040024  0.933198  1.146956  1.169362   4.139161  2.282410   70.767906   3.619682  1.313278
6  16384.0  132.286682  1.938570  1.742662  2.096860  2.479198  14.693004  4.468301  141.657730   7.125336  2.553355
7  32768.0  264.327545  3.727588  3.370777  4.024768  4.221050  57.099262  8.906665  283.827637  14.218192  5.121131
```

#### Memory
```
lasd-memory-fwd-batch1-head16-dim128-bf16:
         n      LASD_R      LASD_P      LAND_P     LASD_PL     LASD3_P       Flash           LP           LC        GLA_K     GLA_S_K
0    256.0    6.008301    6.508301    6.508301    6.508301    6.516113    9.055664     9.008789     8.008789    11.008301    8.023926
1    512.0   11.016113   12.516113   12.516113   12.516113   12.531738   26.172852    18.016602    16.016602    21.016113   15.047363
2   1024.0   21.031738   22.531738   22.531738   22.531738   22.562988   20.094727    36.032227    32.032227    41.031738   29.094238
3   2048.0   41.062988   44.562988   44.562988   44.562988   44.625488   40.188477    72.063477    64.063477    81.062988   57.187988
4   4096.0   81.125488   88.625488   88.625488   88.625488   88.750488   80.375977   144.125977   128.125977   161.125488  113.375488
5   8192.0  161.250488  176.750488  176.750488  176.750488  177.000488  160.750977   288.250977   256.250977   321.250488  225.750488
6  16384.0  321.500488  353.000488  353.000488  353.000488  353.500488  321.500977   576.500977   512.500977   641.500488  450.500488
7  32768.0  642.000488  705.500488  705.500488  705.500488  706.500488  643.000977  1153.000977  1025.000977  1282.000488  900.000488

lasd-memory-bwd-batch1-head16-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC        GLA_K      GLA_S_K
0    256.0    13.408301    14.908301    14.908301    15.448242    15.454102    13.440039    16.408789    14.608789    33.208301    20.445801
1    512.0    24.816113    28.516113    28.516113    29.095117    29.107227    26.879102    32.816602    29.216602    65.416113    39.891113
2   1024.0    47.631738    51.131738    51.131738    51.788867    51.813477    53.757227    65.632227    58.432227   129.831738    78.781738
3   2048.0    93.262988   100.762988   100.762988   101.576367   101.625977   107.513477   131.263477   116.863477   258.662988   156.562988
4   4096.0   184.525488   200.025488   200.025488   201.151367   201.250977   215.025977   262.525977   233.725977   516.325488   312.125488
5   8192.0   367.050488   398.550488   398.550488   400.301367   400.500977   430.050977   525.050977   467.450977  1031.650488   623.250488
6  16384.0   732.100488   795.600488   795.600488   798.601367   799.000977   860.100977  1050.100977   934.900977  2062.300488  1245.500488
7  32768.0  1462.200488  1589.700488  1589.700488  1595.201367  1596.000977  1720.200977  2100.200977  1869.800977  4123.600488  2490.000488
```
