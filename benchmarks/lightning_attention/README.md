# Lightning Attention with Scalar Decay

## Notation

- lasd_r: Triton recurrence
- lasd_p: Lightning attention with scalar decay
- land_p: Lightning attention with no decay
- lasd_pl: Lightning attention with learnable scalar decay
- lasd3_p: Lightning attention with data-dependent scalar decay
- lavd_p: Lightning attention with vector decay
- flash: Flash attention
- lightning_p: Origin lightning attention parallel version
- lightning_c: Origin lightning attention chunk loop version

## A100

## Lavd
```
lasd-speed-fwd-batch4-head32-dim128-bf16:
         n   LAVD_K_P  LAVD_KV_P      GLA_K
0    256.0   0.291912   0.458201   0.331966
1    512.0   0.527728   0.869762   0.509887
2   1024.0   1.020478   1.665060   0.964411
3   2048.0   2.003170   3.263634   1.878093
4   4096.0   3.979225   6.477329   3.750715
5   8192.0   7.931538  12.993783   7.541895
6  16384.0  15.915184  25.957151  15.260550
7  32768.0  31.859659  52.019745  31.055510

lasd-speed-bwd-batch4-head32-dim128-bf16:
         n   LAVD_K_P   LAVD_KV_P       GLA_K
0    256.0   0.928019    1.638246    0.898103
1    512.0   1.515963    3.101078    1.704729
2   1024.0   3.004528    5.930160    3.303894
3   2048.0   5.882918   13.394767    6.520246
4   4096.0  11.679768   26.508406   12.931434
5   8192.0  23.297600   45.345089   25.789087
6  16384.0  46.540817   90.640671   51.632927
7  32768.0  93.078781  180.837479  103.458557

lasd-memory-fwd-batch4-head32-dim128-bf16:
         n     LAVD_K_P    LAVD_KV_P         GLA_K
0    256.0    69.062988    77.062988     96.062988
1    512.0   134.125488   150.125488    184.125488
2   1024.0   264.250488   296.250488    360.250488
3   2048.0   524.500488   588.500488    712.500488
4   4096.0  1045.000488  1173.000488   1417.000488
5   8192.0  2086.000488  2342.000488   2826.000488
6  16384.0  4168.000488  4680.000488   5644.000488
7  32768.0  8332.000488  9356.000488  11280.000488

lasd-memory-bwd-batch4-head32-dim128-bf16:
         n      LAVD_K_P     LAVD_KV_P         GLA_K
0    256.0    187.694238    242.094238    273.662988
1    512.0    359.356738    468.156738    539.325488
2   1024.0    702.681738    920.281738   1070.650488
3   2048.0   1389.331738   1824.531738   2133.300488
4   4096.0   2762.631738   3633.031738   4258.600488
5   8192.0   5509.231738   7250.031738   8509.200488
6  16384.0  11002.431738  14484.031738  17010.400488
7  32768.0  21988.831738  28952.031738  34012.800488

lasd-speed-fwd-batch1-head16-dim128-bf16:
         n  LAVD_K_P  LAVD_KV_P     GLA_K
0    256.0  0.371602   0.445075  0.323281
1    512.0  0.371930   0.457323  0.322356
2   1024.0  0.388200   0.479862  0.337151
3   2048.0  0.431278   0.556141  0.353589
4   4096.0  0.562735   0.893352  0.613177
5   8192.0  1.118289   1.760072  1.183879
6  16384.0  2.231562   3.478146  2.353532
7  32768.0  4.431886   7.477627  4.721832

lasd-speed-bwd-batch1-head16-dim128-bf16:
         n   LAVD_K_P  LAVD_KV_P      GLA_K
0    256.0   1.069991   1.511770   0.693602
1    512.0   1.004906   1.523573   0.815348
2   1024.0   0.994700   1.413578   0.698898
3   2048.0   1.089848   2.131326   1.096526
4   4096.0   1.748025   4.071254   1.853006
5   8192.0   3.502315   7.916307   3.544100
6  16384.0   6.883500  15.556272   6.995728
7  32768.0  13.669878  26.494774  13.913733

lasd-memory-fwd-batch1-head16-dim128-bf16:
         n     LAVD_K_P    LAVD_KV_P        GLA_K
0    256.0     8.633301     9.633301    12.008301
1    512.0    16.766113    18.766113    23.016113
2   1024.0    33.031738    37.031738    45.031738
3   2048.0    65.562988    73.562988    89.062988
4   4096.0   130.625488   146.625488   177.125488
5   8192.0   260.750488   292.750488   353.250488
6  16384.0   521.000488   585.000488   705.500488
7  32768.0  1041.500488  1169.500488  1410.000488

lasd-memory-bwd-batch1-head16-dim128-bf16:
         n     LAVD_K_P    LAVD_KV_P        GLA_K
0    256.0    23.462207    30.262207    34.208301
1    512.0    44.920020    58.520020    67.416113
2   1024.0    87.835645   115.035645   133.831738
3   2048.0   173.666895   228.066895   266.662988
4   4096.0   345.329395   454.129395   532.325488
5   8192.0   688.654395   906.254395  1063.650488
6  16384.0  1375.304395  1810.504395  2126.300488
7  32768.0  2748.604395  3619.004395  4251.600488
```

### Large Batch * Number of Heads

#### Speed
cusmum fp32
```
lasd-speed-fwd-batch4-head32-dim128-bf16:
         n     LACD_R    LACD_P    LAND_P   LACD_PL    LASD_P   LAVD_K_P  LAVD_KV_P     LASR_R       Flash         LP         LC      GLA_K   GLA_S_K
0    256.0   0.652793  0.136474  0.138360  0.137791  0.235322   0.407724   0.558429   0.176839    0.053686   0.239615   0.206556   0.342764  0.242304
1    512.0   1.267493  0.152127  0.140765  0.151923  0.282350   0.644439   1.040229   0.335500    0.106769   0.438777   0.375317   0.509272  0.207362
2   1024.0   2.500505  0.276702  0.247216  0.276934  0.256408   1.245925   2.024619   0.653281    0.256097   0.861626   0.713751   0.959493  0.271250
3   2048.0   4.947973  0.509485  0.452708  0.509540  0.471993   2.443105   3.985888   1.290094    0.787793   1.665744   1.389346   1.877250  0.504852
4   4096.0   9.828731  0.969637  0.864322  0.969851  0.893847   4.853489   7.917278   2.581057    2.818286   3.269520   2.747067   3.734363  0.975576
5   8192.0  19.628180  1.888769  1.673330  1.884513  1.765124   9.653328  15.803216   5.160818   10.697251   6.451407   5.450449   7.499264  1.916965
6  16384.0  39.096783  3.771507  3.331862  3.776350  3.541250  19.293276  31.563520  10.347673   41.806736  12.816183  10.888772  15.196518  3.863883
7  32768.0  78.665504  7.491744  6.587899  7.475981  7.150563  38.459808  63.203362  20.731785  165.804382  25.477676  21.746920  30.880865  7.964277

lasd-speed-bwd-batch4-head32-dim128-bf16:
         n      LACD_R     LACD_P     LAND_P    LACD_PL     LASD_P    LAVD_K_P   LAVD_KV_P     LASR_R       Flash         LP          LC       GLA_K    GLA_S_K
0    256.0    3.055475   0.498816   0.450975   0.767788   1.017257    1.276722    2.218930   0.669227    0.188301   0.626994    5.808800    0.902207   0.683739
1    512.0    7.460204   0.506414   0.457625   0.700420   0.872225    1.942879    4.309085   1.341185    0.385159   1.189214   12.454048    1.704654   0.658891
2   1024.0   14.728352   0.859191   0.808556   0.887128   0.877827    3.781536    8.503171   2.662424    0.935153   2.267494   25.170847    3.297926   1.081765
3   2048.0   24.266411   1.588533   1.502124   1.616311   1.609325    7.396851   16.423321   5.327791    2.673806   4.374016   50.847553    6.476582   2.096054
4   4096.0   48.585918   3.021116   2.881403   3.056340   3.105366   14.783215   28.063402  10.666404    8.627415   8.651768  101.992676   12.936036   4.206569
5   8192.0   97.005981   5.874044   5.574690   5.928560   6.014190   26.337151   55.848415  21.636143   30.857386  17.640499  204.511139   25.863882   8.662067
6  16384.0  194.168518  11.603015  11.190285  11.779248  12.081539   52.391968  111.394623  43.496513  116.146049  35.191055  408.409332   51.846657  17.825428
7  32768.0  388.115326  22.977921  21.668079  23.358223  23.799706  104.688164  222.614502  88.255676  450.368469  70.063614  819.759094  104.167297  36.675407
```


```
lasd-speed-fwd-batch4-head32-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P       Flash         LP         LC      GLA_K   GLA_S_K
0    256.0   0.655933  0.108678  0.106083  0.109908  0.195713    0.053710   0.240091   0.206705   0.327201  0.204735
1    512.0   1.271388  0.152374  0.141474  0.152283  0.200799    0.107207   0.440321   0.376162   0.510458  0.191493
2   1024.0   2.509821  0.276325  0.245753  0.276183  0.254577    0.257119   0.863307   0.715392   0.960371  0.271407
3   2048.0   4.968386  0.509175  0.453194  0.509453  0.467332    0.809526   1.681705   1.392455   1.876552  0.505282
4   4096.0   9.908035  0.969750  0.861891  0.970814  0.887678    2.881795   3.274936   2.744257   3.735319  0.977764
5   8192.0  19.668352  1.897657  1.678227  1.898757  1.740259   10.935886   6.480638   5.444317   7.484749  1.929669
6  16384.0  39.408688  3.758053  3.324778  3.756764  3.501100   42.233791  12.823145  10.877553  15.183131  3.903088
7  32768.0  79.005890  7.466728  6.597260  7.477282  7.164628  168.157181  25.540907  21.772785  30.905098  8.046275

lasd-speed-bwd-batch4-head32-dim128-bf16:
         n      LASD_R     LASD_P     LAND_P    LASD_PL    LASD3_P       Flash         LP          LC       GLA_K    GLA_S_K
0    256.0    3.068582   0.463380   0.393717   0.630318   0.752022    0.188258   0.636459    6.002990    0.902797   0.660426
1    512.0    6.115036   0.430602   0.458929   0.673490   0.733389    0.385261   1.190071   12.546618    1.705835   0.671198
2   1024.0   12.232876   0.768539   0.726005   0.887880   0.858921    0.937031   2.266356   25.436972    3.295599   1.084280
3   2048.0   24.346327   1.424496   1.346300   1.615501   1.563278    2.677297   4.367430   51.231647    6.493480   2.100296
4   4096.0   48.788338   2.731698   2.594848   3.065602   2.993264    8.763721   8.651947  102.849091   12.915675   4.191836
5   8192.0   97.388031   5.335991   5.098080   5.976079   5.907910   31.447393  17.697056  205.966949   25.818390   8.594414
6  16384.0  194.820541  10.483577  10.040649  11.787160  11.752840  119.359810  35.182350  412.115265   51.721664  17.729723
7  32768.0  389.312531  20.646193  19.940105  23.367889  23.594353  463.029419  70.132156  825.480347  103.709602  36.445553
```

#### Memory
```
lasd-memory-fwd-batch4-head32-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC         GLA_K      GLA_S_K
0    256.0    48.062988    52.062988    52.062988    52.062988    52.125488    40.188477    72.063477    64.063477     88.062988    64.187988
1    512.0    88.125488   100.125488   100.125488   100.125488   100.250488    80.375977   144.125977   128.125977    168.125488   120.375488
2   1024.0   168.250488   196.250488   196.250488   196.250488   196.500488   160.750977   288.250977   256.250977    328.250488   232.750488
3   2048.0   328.500488   388.500488   388.500488   388.500488   389.000488   321.500977   576.500977   512.500977    648.500488   457.500488
4   4096.0   649.000488   773.000488   773.000488   773.000488   774.000488   643.000977  1153.000977  1025.000977   1289.000488   907.000488
5   8192.0  1290.000488  1542.000488  1542.000488  1542.000488  1544.000488  1286.000977  2306.000977  2050.000977   2570.000488  1806.000488
6  16384.0  2572.000488  3080.000488  3080.000488  3080.000488  3084.000488  2572.000977  4612.000977  4100.000977   5132.000488  3604.000488
7  32768.0  5136.000488  6156.000488  6156.000488  6156.000488  6164.000488  5144.000977  9224.000977  8200.000977  10256.000488  7200.000488

lasd-memory-bwd-batch4-head32-dim128-bf16:
         n        LASD_R        LASD_P        LAND_P       LASD_PL       LASD3_P         Flash            LP            LC         GLA_K       GLA_S_K
0    256.0    107.262988    119.262988    119.262988    123.451367    123.625977    107.513477    131.263477    116.863477    265.662988    163.562988
1    512.0    198.525488    226.525488    226.525488    230.901367    231.250977    215.025977    262.525977    233.725977    523.325488    319.125488
2   1024.0    381.050488    441.050488    441.050488    445.801367    446.500977    430.050977    525.050977    467.450977   1038.650488    630.250488
3   2048.0    746.100488    870.100488    870.100488    875.601367    877.000977    860.100977   1050.100977    934.900977   2069.300488   1252.500488
4   4096.0   1476.200488   1728.200488   1728.200488   1735.201367   1738.000977   1720.200977   2100.200977   1869.800977   4130.600488   2497.000488
5   8192.0   2936.400488   3444.400488   3444.400488   3454.401367   3460.000977   3440.400977   4200.400977   3739.600977   8253.200488   4986.000488
6  16384.0   5856.800488   6876.800488   6876.800488   6892.801367   6904.000977   6880.800977   8400.800977   7479.200977  16498.400488   9964.000488
7  32768.0  11697.600488  13741.600488  13741.600488  13769.601367  13792.000977  13761.600977  16801.600977  14958.400977  32988.800488  19920.000488
```

### Small Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch1-head16-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP        LC     GLA_K   GLA_S_K
0    256.0   0.527723  0.174217  0.176909  0.183446  0.260103   0.027703  0.213996  0.094211  0.335731  0.235709
1    512.0   1.046471  0.182126  0.179876  0.183411  0.310545   0.045031  0.216245  0.097134  0.315967  0.193928
2   1024.0   2.104761  0.180043  0.176954  0.182976  0.277731   0.071937  0.229542  0.133061  0.358419  0.201689
3   2048.0   4.248014  0.190712  0.181955  0.193232  0.271724   0.160317  0.251444  0.246308  0.334149  0.196808
4   4096.0   8.440368  0.200947  0.178742  0.200930  0.272583   0.460840  0.475818  0.467264  0.573042  0.218469
5   8192.0  16.844622  0.360968  0.319696  0.360907  0.365110   1.531961  0.973514  0.909793  1.103711  0.384872
6  16384.0  33.594162  0.662543  0.586012  0.662572  0.668430   5.667757  1.870281  1.796580  2.176550  0.747462
7  32768.0  67.052925  1.267746  1.126125  1.268292  1.275615  21.631960  3.698275  3.569899  4.363943  1.475306

lasd-speed-bwd-batch1-head16-dim128-bf16:
         n      LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP          LC      GLA_K   GLA_S_K
0    256.0    1.968356  0.464231  0.476634  0.755548  0.836571   0.144012  0.230492    2.128039   0.706817  0.598664
1    512.0    3.899179  0.537519  0.468291  0.760714  0.866158   0.143359  0.291417    4.327662   0.709635  0.595612
2   1024.0    7.856725  0.523216  0.509367  0.792498  0.796522   0.174761  0.366078    8.678242   0.707281  0.572364
3   2048.0   16.140554  0.567779  0.589498  0.763521  0.837778   0.451503  0.623165   17.715717   0.972260  0.641337
4   4096.0   32.658337  0.565033  0.508802  0.694658  0.830432   1.271837  1.162379   35.475037   1.861877  0.665994
5   8192.0   65.738945  1.041164  0.934942  1.173354  1.168996   4.132259  2.288872   70.895966   3.622967  1.265004
6  16384.0  132.287964  1.940515  1.743646  2.173406  2.185210  14.996352  4.471437  142.394653   7.125216  2.453145
7  32768.0  264.312408  3.727781  3.370177  4.189341  4.229684  57.610497  8.893124  283.428101  14.221061  4.874319
```

#### Memory
```
lasd-memory-fwd-batch1-head16-dim128-bf16:
         n      LASD_R      LASD_P      LAND_P     LASD_PL     LASD3_P       Flash           LP           LC        GLA_K     GLA_S_K
0    256.0    6.008301    6.508301    6.508301    6.508301    6.516113    9.055664     9.008789     8.008789    11.008301    8.023926
1    512.0   11.016113   12.516113   12.516113   12.516113   12.531738   26.172852    18.016602    16.016602    21.016113   15.047363
2   1024.0   21.031738   22.531738   22.531738   22.531738   22.562988   20.094727    36.032227    32.032227    41.031738   29.094238
3   2048.0   41.062988   44.562988   44.562988   44.562988   44.625488   40.188477    72.063477    64.063477    81.062988   57.187988
4   4096.0   81.125488   88.625488   88.625488   88.625488   88.750488   80.375977   144.125977   128.125977   161.125488  113.375488
5   8192.0  161.250488  176.750488  176.750488  176.750488  177.000488  160.750977   288.250977   256.250977   321.250488  225.750488
6  16384.0  321.500488  353.000488  353.000488  353.000488  353.500488  321.500977   576.500977   512.500977   641.500488  450.500488
7  32768.0  642.000488  705.500488  705.500488  705.500488  706.500488  643.000977  1153.000977  1025.000977  1282.000488  900.000488

lasd-memory-bwd-batch1-head16-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC        GLA_K      GLA_S_K
0    256.0    13.408301    14.908301    14.908301    15.432617    15.454102    13.440039    16.408789    14.608789    33.208301    20.445801
1    512.0    24.816113    28.516113    28.516113    29.063867    29.107227    26.879102    32.816602    29.216602    65.416113    39.891113
2   1024.0    47.631738    51.131738    51.131738    51.726367    51.813477    53.757227    65.632227    58.432227   129.831738    78.781738
3   2048.0    93.262988   100.762988   100.762988   101.451367   101.625977   107.513477   131.263477   116.863477   258.662988   156.562988
4   4096.0   184.525488   200.025488   200.025488   200.901367   201.250977   215.025977   262.525977   233.725977   516.325488   312.125488
5   8192.0   367.050488   398.550488   398.550488   399.801367   400.500977   430.050977   525.050977   467.450977  1031.650488   623.250488
6  16384.0   732.100488   795.600488   795.600488   797.633105   799.000977   860.100977  1050.100977   934.900977  2062.300488  1245.500488
7  32768.0  1462.200488  1589.700488  1589.700488  1593.764355  1596.000977  1720.200977  2100.200977  1869.800977  4123.600488  2490.000488
```
