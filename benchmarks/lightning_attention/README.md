# Lightning Attention with Scalar Decay

## Notation

- lasd_r: Triton recurrence
- lasd_p: Lightning attention with scalar decay
- land_p: Lightning attention with no decay
- lasd_pl: Lightning attention with learnable scalar decay
- lasd3_p: Lightning attention with data-dependent scalar decay
- flash: Flash attention
- lightning_p: Origin lightning attention parallel version
- lightning_c: Origin lightning attention chunk loop version

## A100

### Large Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch4-head32-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P       Flash         LP         LC      GLA_K   GLA_S_K
0    256.0   0.655933  0.108678  0.106083  0.109908  0.195713    0.053710   0.240091   0.206705   0.327201  0.204735
1    512.0   1.271388  0.152374  0.141474  0.152283  0.200799    0.107207   0.440321   0.376162   0.510458  0.191493
2   1024.0   2.509821  0.276325  0.245753  0.276183  0.254577    0.257119   0.863307   0.715392   0.960371  0.271407
3   2048.0   4.968386  0.509175  0.453194  0.509453  0.467332    0.809526   1.681705   1.392455   1.876552  0.505282
4   4096.0   9.908035  0.969750  0.861891  0.970814  0.887678    2.881795   3.274936   2.744257   3.735319  0.977764
5   8192.0  19.668352  1.897657  1.678227  1.898757  1.740259   10.935886   6.480638   5.444317   7.484749  1.929669
6  16384.0  39.408688  3.758053  3.324778  3.756764  3.501100   42.233791  12.823145  10.877553  15.183131  3.903088
7  32768.0  79.005890  7.466728  6.597260  7.477282  7.164628  168.157181  25.540907  21.772785  30.905098  8.046275

lasd-speed-bwd-batch4-head32-dim128-bf16:
         n      LASD_R     LASD_P     LAND_P    LASD_PL    LASD3_P       Flash         LP          LC       GLA_K    GLA_S_K
0    256.0    3.068582   0.463380   0.393717   0.630318   0.752022    0.188258   0.636459    6.002990    0.902797   0.660426
1    512.0    6.115036   0.430602   0.458929   0.673490   0.733389    0.385261   1.190071   12.546618    1.705835   0.671198
2   1024.0   12.232876   0.768539   0.726005   0.887880   0.858921    0.937031   2.266356   25.436972    3.295599   1.084280
3   2048.0   24.346327   1.424496   1.346300   1.615501   1.563278    2.677297   4.367430   51.231647    6.493480   2.100296
4   4096.0   48.788338   2.731698   2.594848   3.065602   2.993264    8.763721   8.651947  102.849091   12.915675   4.191836
5   8192.0   97.388031   5.335991   5.098080   5.976079   5.907910   31.447393  17.697056  205.966949   25.818390   8.594414
6  16384.0  194.820541  10.483577  10.040649  11.787160  11.752840  119.359810  35.182350  412.115265   51.721664  17.729723
7  32768.0  389.312531  20.646193  19.940105  23.367889  23.594353  463.029419  70.132156  825.480347  103.709602  36.445553
```

#### Memory
```
lasd-memory-fwd-batch4-head32-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC         GLA_K      GLA_S_K
0    256.0    48.062988    52.062988    52.062988    52.062988    52.125488    40.188477    72.063477    64.063477     88.062988    64.187988
1    512.0    88.125488   100.125488   100.125488   100.125488   100.250488    80.375977   144.125977   128.125977    168.125488   120.375488
2   1024.0   168.250488   196.250488   196.250488   196.250488   196.500488   160.750977   288.250977   256.250977    328.250488   232.750488
3   2048.0   328.500488   388.500488   388.500488   388.500488   389.000488   321.500977   576.500977   512.500977    648.500488   457.500488
4   4096.0   649.000488   773.000488   773.000488   773.000488   774.000488   643.000977  1153.000977  1025.000977   1289.000488   907.000488
5   8192.0  1290.000488  1542.000488  1542.000488  1542.000488  1544.000488  1286.000977  2306.000977  2050.000977   2570.000488  1806.000488
6  16384.0  2572.000488  3080.000488  3080.000488  3080.000488  3084.000488  2572.000977  4612.000977  4100.000977   5132.000488  3604.000488
7  32768.0  5136.000488  6156.000488  6156.000488  6156.000488  6164.000488  5144.000977  9224.000977  8200.000977  10256.000488  7200.000488

lasd-memory-bwd-batch4-head32-dim128-bf16:
         n        LASD_R        LASD_P        LAND_P       LASD_PL       LASD3_P         Flash            LP            LC         GLA_K       GLA_S_K
0    256.0    107.262988    119.262988    119.262988    123.451367    123.625977    107.513477    131.263477    116.863477    265.662988    163.562988
1    512.0    198.525488    226.525488    226.525488    230.901367    231.250977    215.025977    262.525977    233.725977    523.325488    319.125488
2   1024.0    381.050488    441.050488    441.050488    445.801367    446.500977    430.050977    525.050977    467.450977   1038.650488    630.250488
3   2048.0    746.100488    870.100488    870.100488    875.601367    877.000977    860.100977   1050.100977    934.900977   2069.300488   1252.500488
4   4096.0   1476.200488   1728.200488   1728.200488   1735.201367   1738.000977   1720.200977   2100.200977   1869.800977   4130.600488   2497.000488
5   8192.0   2936.400488   3444.400488   3444.400488   3454.401367   3460.000977   3440.400977   4200.400977   3739.600977   8253.200488   4986.000488
6  16384.0   5856.800488   6876.800488   6876.800488   6892.801367   6904.000977   6880.800977   8400.800977   7479.200977  16498.400488   9964.000488
7  32768.0  11697.600488  13741.600488  13741.600488  13769.601367  13792.000977  13761.600977  16801.600977  14958.400977  32988.800488  19920.000488
```

### Small Batch * Number of Heads

#### Speed
```
lasd-speed-fwd-batch1-head16-dim128-bf16:
         n     LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP        LC     GLA_K   GLA_S_K
0    256.0   0.527723  0.174217  0.176909  0.183446  0.260103   0.027703  0.213996  0.094211  0.335731  0.235709
1    512.0   1.046471  0.182126  0.179876  0.183411  0.310545   0.045031  0.216245  0.097134  0.315967  0.193928
2   1024.0   2.104761  0.180043  0.176954  0.182976  0.277731   0.071937  0.229542  0.133061  0.358419  0.201689
3   2048.0   4.248014  0.190712  0.181955  0.193232  0.271724   0.160317  0.251444  0.246308  0.334149  0.196808
4   4096.0   8.440368  0.200947  0.178742  0.200930  0.272583   0.460840  0.475818  0.467264  0.573042  0.218469
5   8192.0  16.844622  0.360968  0.319696  0.360907  0.365110   1.531961  0.973514  0.909793  1.103711  0.384872
6  16384.0  33.594162  0.662543  0.586012  0.662572  0.668430   5.667757  1.870281  1.796580  2.176550  0.747462
7  32768.0  67.052925  1.267746  1.126125  1.268292  1.275615  21.631960  3.698275  3.569899  4.363943  1.475306

lasd-speed-bwd-batch1-head16-dim128-bf16:
         n      LASD_R    LASD_P    LAND_P   LASD_PL   LASD3_P      Flash        LP          LC      GLA_K   GLA_S_K
0    256.0    1.968356  0.464231  0.476634  0.755548  0.836571   0.144012  0.230492    2.128039   0.706817  0.598664
1    512.0    3.899179  0.537519  0.468291  0.760714  0.866158   0.143359  0.291417    4.327662   0.709635  0.595612
2   1024.0    7.856725  0.523216  0.509367  0.792498  0.796522   0.174761  0.366078    8.678242   0.707281  0.572364
3   2048.0   16.140554  0.567779  0.589498  0.763521  0.837778   0.451503  0.623165   17.715717   0.972260  0.641337
4   4096.0   32.658337  0.565033  0.508802  0.694658  0.830432   1.271837  1.162379   35.475037   1.861877  0.665994
5   8192.0   65.738945  1.041164  0.934942  1.173354  1.168996   4.132259  2.288872   70.895966   3.622967  1.265004
6  16384.0  132.287964  1.940515  1.743646  2.173406  2.185210  14.996352  4.471437  142.394653   7.125216  2.453145
7  32768.0  264.312408  3.727781  3.370177  4.189341  4.229684  57.610497  8.893124  283.428101  14.221061  4.874319
```

#### Memory
```
lasd-memory-fwd-batch1-head16-dim128-bf16:
         n      LASD_R      LASD_P      LAND_P     LASD_PL     LASD3_P       Flash           LP           LC        GLA_K     GLA_S_K
0    256.0    6.008301    6.508301    6.508301    6.508301    6.516113    9.055664     9.008789     8.008789    11.008301    8.023926
1    512.0   11.016113   12.516113   12.516113   12.516113   12.531738   26.172852    18.016602    16.016602    21.016113   15.047363
2   1024.0   21.031738   22.531738   22.531738   22.531738   22.562988   20.094727    36.032227    32.032227    41.031738   29.094238
3   2048.0   41.062988   44.562988   44.562988   44.562988   44.625488   40.188477    72.063477    64.063477    81.062988   57.187988
4   4096.0   81.125488   88.625488   88.625488   88.625488   88.750488   80.375977   144.125977   128.125977   161.125488  113.375488
5   8192.0  161.250488  176.750488  176.750488  176.750488  177.000488  160.750977   288.250977   256.250977   321.250488  225.750488
6  16384.0  321.500488  353.000488  353.000488  353.000488  353.500488  321.500977   576.500977   512.500977   641.500488  450.500488
7  32768.0  642.000488  705.500488  705.500488  705.500488  706.500488  643.000977  1153.000977  1025.000977  1282.000488  900.000488

lasd-memory-bwd-batch1-head16-dim128-bf16:
         n       LASD_R       LASD_P       LAND_P      LASD_PL      LASD3_P        Flash           LP           LC        GLA_K      GLA_S_K
0    256.0    13.408301    14.908301    14.908301    15.432617    15.454102    13.440039    16.408789    14.608789    33.208301    20.445801
1    512.0    24.816113    28.516113    28.516113    29.063867    29.107227    26.879102    32.816602    29.216602    65.416113    39.891113
2   1024.0    47.631738    51.131738    51.131738    51.726367    51.813477    53.757227    65.632227    58.432227   129.831738    78.781738
3   2048.0    93.262988   100.762988   100.762988   101.451367   101.625977   107.513477   131.263477   116.863477   258.662988   156.562988
4   4096.0   184.525488   200.025488   200.025488   200.901367   201.250977   215.025977   262.525977   233.725977   516.325488   312.125488
5   8192.0   367.050488   398.550488   398.550488   399.801367   400.500977   430.050977   525.050977   467.450977  1031.650488   623.250488
6  16384.0   732.100488   795.600488   795.600488   797.633105   799.000977   860.100977  1050.100977   934.900977  2062.300488  1245.500488
7  32768.0  1462.200488  1589.700488  1589.700488  1593.764355  1596.000977  1720.200977  2100.200977  1869.800977  4123.600488  2490.000488
```
